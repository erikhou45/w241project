---
title: "W241 Final Project"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown



```{r}
# Load packages
library(foreign)
library(data.table)
library(knitr)
library(sandwich)
library(lmtest)
library(dplyr)
library(AER)
library(stargazer)
```

## Covariate Balance Check

Since we don't have access to define the randomization process for A/B testing on Facebook. We definitely want to check the covariates' balance in different treatment groups.

```{r}
# load the raw aggregated data downloaded from Facebook with gender and age
d_raw_ag <- fread("data_w241_final_project_ag.csv")
d_raw_ag <- as.data.frame(d_raw_ag)
d_raw_ag
```

```{r}
# Transform the data by creating records from the aggregated records

# Transform the data by creating records from the aggregated records

ROW_COUNT = nrow(d_raw_ag)
reivew_image = c()
postive_review = c()
ad = c()
ad_desc = c()
age_group = c()
gender = c()
click = c()

for (i in 1:ROW_COUNT) {
  ad_set <- d_raw_ag[i,"Ad Set Name"]
  age <- d_raw_ag[i, "Age"]
  gen <- d_raw_ag[i, "Gender"]
  reach <- d_raw_ag[i, "Reach"]
  unique_clicks <- d_raw_ag[i, "Unique Link Clicks"]
  # print(unique_clicks)
  
  if (ad_set == "Ad Set for Ad A") {
    reivew_image <- append(reivew_image, rep(1, reach))
    postive_review <- append(postive_review, rep(1, reach))
    ad <- append(ad, rep("A", reach))
    ad_desc <- append(ad_desc, rep("Positve Reveiw with Image", reach))
  } else if (ad_set == "Ad Set for Ad B") {
    reivew_image <- append(reivew_image, rep(0, reach))
    postive_review <- append(postive_review, rep(1, reach))
    ad <- append(ad, rep("B", reach))
    ad_desc <- append(ad_desc, rep("Positve Reveiw without Image", reach))
  } else if (ad_set == "Ad Set for Ad C") {
    reivew_image <- append(reivew_image, rep(1, reach))
    postive_review <- append(postive_review, rep(0, reach))
    ad <- append(ad, rep("C", reach))
    ad_desc <- append(ad_desc, rep("Negative Reveiw with Image", reach))
  } else {
    reivew_image <- append(reivew_image, rep(0, reach))
    postive_review <- append(postive_review, rep(0, reach))
    ad <- append(ad, rep("D", reach))
    ad_desc <- append(ad_desc, rep("Negative Reveiw without Image", reach))
  }
  
  age_group <- append(age_group, rep(age, reach))
  gender <- append(gender, rep(gen, reach))
  
  if (is.na(unique_clicks)) {
    click <- append(click, rep(0, reach))
  }
  else {
    click <- append(click, rep(1, unique_clicks))
    click <- append(click, rep(0, reach - unique_clicks))
  }
}

d_ag <- data.table(
                     ad = ad,
                     ad_desc = ad_desc,
                     reivew_image = reivew_image,
                     postive_review = postive_review,
                     age_group = age_group,
                     gender = gender,
                     click = click)

# Look at data summary to confirm the number of data loaded and check means and quntiles
summary(d_ag)
d_ag[10000,]
```
```{r}
d_ag[, unique(gender)]
```


```{r}
mod_cov_check_1 <- d_ag[, lm(reivew_image ~ as.factor(gender))]
mod_cov_check_2 <- d_ag[, lm(reivew_image ~ as.factor(age_group))]
# mod_cov_check_1 <- d_ag[, lm(as.factor(gender) ~ ad)]
summary(mod_cov_check_1)
summary(mod_cov_check_2)
```

```{r}
null_mod <- d_ag[ , lm(reivew_image ~ 1)]
full_mod <- d_ag[ , lm(reivew_image ~ as.factor(gender)+as.factor(age_group))]
anova_mod <- anova(full_mod, null_mod, test = 'F')
anova_mod
```



```{r}
mod_1 <- d_ag[, lm(click ~ reivew_image + postive_review + reivew_image * postive_review)]
summary(mod_1)
mod_2 <- d_ag[, lm(click ~ reivew_image + postive_review + reivew_image * postive_review
                   + as.factor(gender))]
summary(mod_2)
```



```{r}
# load the raw aggregated data downloaded from Facebook with device platform
d_raw_plat <- fread("data_w241_final_project.csv")
d_raw_plat <- as.data.frame(d_raw_plat)
head(d_raw_plat)
```

```{r}
v = c("ABC D")
v == "ABC D"
is.vector(v)

v1 = v[1]
is.vector(v1)
print(v1)
print(1)
```


```{r}
# Transform the data by creating records from the aggregated records

ROW_COUNT = nrow(d_raw_plat)
reivew_image = c()
postive_review = c()
ad = c()
ad_desc = c()
platform = c()
click = c()

for (i in 1:ROW_COUNT) {
  ad_set <- d_raw_plat[i,"Ad Set Name"]
  device_platform <- d_raw_plat[i, "Device Platform"]
  reach <- d_raw_plat[i, "Reach"]
  unique_clicks <- d_raw_plat[i, "Unique Link Clicks"]
  
  if (ad_set == "Ad Set for Ad A") {
    reivew_image <- append(reivew_image, rep(1, reach))
    postive_review <- append(postive_review, rep(1, reach))
    ad <- append(ad, rep("A", reach))
    ad_desc <- append(ad_desc, rep("Positve Reveiw with Image", reach))
  } else if (ad_set == "Ad Set for Ad B") {
    reivew_image <- append(reivew_image, rep(0, reach))
    postive_review <- append(postive_review, rep(1, reach))
    ad <- append(ad, rep("B", reach))
    ad_desc <- append(ad_desc, rep("Positve Reveiw without Image", reach))
  } else if (ad_set == "Ad Set for Ad C") {
    reivew_image <- append(reivew_image, rep(1, reach))
    postive_review <- append(postive_review, rep(0, reach))
    ad <- append(ad, rep("C", reach))
    ad_desc <- append(ad_desc, rep("Negative Reveiw with Image", reach))
  } else {
    reivew_image <- append(reivew_image, rep(0, reach))
    postive_review <- append(postive_review, rep(0, reach))
    ad <- append(ad, rep("D", reach))
    ad_desc <- append(ad_desc, rep("Negative Reveiw without Image", reach))
  }
  
  platform <- append(platform, rep(device_platform, reach))
  
  click <- append(click, rep(1, unique_clicks))
  click <- append(click, rep(0, reach - unique_clicks))
}

d_plat <- data.table(
                     ad = ad,
                     ad_desc = ad_desc,
                     reivew_image = reivew_image,
                     postive_review = postive_review,
                     platform = platform,
                     click = click)

# Look at data summary to confirm the number of data loaded and check means and quntiles
summary(d_plat)
```


```{r}
mod_1 <- d_plat[, lm(click ~ reivew_image + postive_review + reivew_image * postive_review)]
summary(mod_1)

# When negative review + WITHOUT PICTURE -> positive review + WITHOUT PICTIRE: the impact in click rate we expect (-0.0017)
```

```{r}
d_plat[, negative_review := (postive_review - 1) * -1]
d_plat[, no_image := (reivew_image - 1) * -1]

mod_2 <- d_plat[, lm(click ~ no_image + negative_review + no_image * negative_review)]
summary(mod_2)

# The negative_review here means:
# When positve review + PICTURE -> negative review + picture: the impact in click rate we expect
# When positive review + WITHOUT PICTURE -> negative reivew + WITHOUT PICTURE: (-0.0058+0.0075=0.0017)
```

__Check the rubrics (both paper and presentation)__
1. think about what needs to be added to the presentation
2. think about any questions for the paper

Things to think about for analysis:
1. whether to use robust se
2. our plan and excution of HTEs

Things for discussion
1. potential interference from post sharing and comments
2. mediation discussion what really caused the difference
    a. the composition of the cards
    b. the potential issues from the smiling pictures
3. future work




```{r}
#data preparation
#d <- ('http://ischool.berkeley.edu/~d.alex.hughes/data/hill_kousser_analysisFile.csv')

# d <- data.frame("id" = 1:103126)
# 
# d$adgroup  = c(rep("Ad Set A", 23616),  rep("Ad Set B", 23496), rep("Ad Set C", 27230), rep("Ad Set D", 28784))
# 
# d$platform  = c(rep("mobile_app", 22272),  rep("mobile_web", 1072),rep("desktop", 272), 
#                 rep("mobile_app", 22032),  rep("mobile_web", 952),rep("desktop", 512),
#                 rep("mobile_app", 25600), rep("desktop", 934), rep("mobile_web", 696),
#                 rep("mobile_app", 25888), rep("desktop", 1856), rep("mobile_web", 1040))
# 
# 
# 
# d$uniqueclicks = c(rep(1, 569), rep(0, 22272 - 569), rep(1, 22), rep(0, 1072-22), rep(1,9), rep(0,272-9),
#                    rep(1, 320), rep(0, 22032 - 320), rep(1, 10), rep(0, 952-10), rep(1,3), rep(0,512-3),
#                    rep(1, 503), rep(0, 25600 - 503), rep(1, 16), rep(0, 934-16), rep(1,15), rep(0,696-15),
#                     rep(1, 419), rep(0, 25888 - 419), rep(1, 23), rep(0, 1856-23), rep(1,14), rep(0,1040-14))
# 
# 
# d$picture = c(rep(1,23616), rep(0, 23496), rep(1, 27230), rep(0,28784))
# 
# d$positive_rev = c(rep(1,47112), rep(0,56014))
# 
# head(d)



```



```{r}

# d2 <- data.table(d)
# d$nopicture = 1-d$picture
# d$negative_rev= 1-d$positive_rev
# 
# d2[]
# 
# mod1 = lm(uniqueclicks*100 ~ picture, data = d)
# summary(mod1)
# 
# 
# mod2 = lm(uniqueclicks*100 ~ picture + positive_rev, data = d)
# summary(mod2)
# 
# 
# mod3 = lm(uniqueclicks*100 ~ picture + positive_rev + picture * positive_rev, data = d)
# summary(mod3)
# 
# 
# 
# mod5 = lm(uniqueclicks*100 ~ nopicture+ negative_rev + negative_rev * nopicture, data = d)
# summary(mod5)
# 
# 
# modvar = vcovHC(mod5)
# 
# coeftest(mod5, modvar)

```
